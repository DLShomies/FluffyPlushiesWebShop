FROM maven:3.9-eclipse-temurin-24 AS build

WORKDIR /app

COPY pom.xml .

RUN mvn dependency:go-offline -B

COPY src ./src

RUN mvn package -DskipTests

FROM eclipse-temurin:24-jre

WORKDIR /app

ARG IDENTITY_MYSQL_PASSWORD
ARG IDENTITY_MYSQL_USERNAME
ARG IDENTITY_MYSQL_URL
ARG IDENTITY_MYSQL_SCHEMA

ARG RABBITMQ_HOST
ARG RABBITMQ_PORT
ARG RABBITMQ_USERNAME
ARG RABBITMQ_PASSWORD

ARG JWT_SECRET
ARG IDENTITY_ADMIN_PASSWORD

ENV IDENTITY_MYSQL_USERNAME=${IDENTITY_MYSQL_USERNAME}
ENV IDENTITY_MYSQL_PASSWORD=${IDENTITY_MYSQL_PASSWORD}
ENV IDENTITY_MYSQL_SCHEMA=${IDENTITY_MYSQL_SCHEMA}
ENV IDENTITY_MYSQL_URL=${IDENTITY_MYSQL_URL}

ENV RABBITMQ_HOST=${RABBITMQ_HOST}
ENV RABBITMQ_PORT=${RABBITMQ_PORT}
ENV RABBITMQ_USERNAME=${RABBITMQ_USERNAME}
ENV RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}

ENV JWT_SECRET=${JWT_SECRET}
ENV IDENTITY_ADMIN_PASSWORD=${IDENTITY_ADMIN_PASSWORD}
ENV JAVA_OPTS=""

COPY --from=build /app/target/*.jar app.jar

EXPOSE 8081

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]